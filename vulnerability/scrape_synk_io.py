import csv
import time

import requests
from bs4 import BeautifulSoup


def parse_vulnerabilities(csv_writer, url):
    response = requests.get(url)
    soup = BeautifulSoup(response.text, "html.parser")
    rows = soup.find_all("tr", class_="vue--table__row")

    vulnerabilities = []
    for row in rows:
        tds = row.find_all("td")
        if len(tds) < 4:
            continue

        # Vulnerability
        vulnerability = tds[0].find("a").text.strip()
        print(vulnerability)

        # Affects
        package = tds[1].find("a").text.strip()
        print(package)

        version_range = tds[1].find("span").text.strip()
        print(version_range)

        # Type

        # Published
        published_at = tds[3].find("span").text.strip()
        print(published_at)

        print("\n")

        vulnerabilities.append([
            vulnerability,
            package,
            version_range,
            published_at,
        ])

    writer.writerows(vulnerabilities)


page_end = 16

with open('data.csv', 'wt', encoding='utf-8', newline='') as f:
    writer = csv.writer(f)
    writer.writerow([
        "vulnerability_name",
        "package_name",
        "version_range",
        "published_at",
    ])

    parse_vulnerabilities(writer, "https://security.snyk.io/vuln/cargo")
    for i in range(15):
        time.sleep(1)
        parse_vulnerabilities(writer, "https://security.snyk.io/vuln/cargo/" + str(i + 2))
